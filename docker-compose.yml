services:
  memory-db:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_DB: memory
      POSTGRES_USER: memory
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - memory_db:/var/lib/postgresql/data
    networks:
      - memory
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U memory -d memory"]
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  memory-api:
    build: .
    # To use a prebuilt image instead of building locally, comment out `build`
    # above and uncomment the line below (after pushing to your registry):
    # image: ghcr.io/${GITHUB_ORG}/memory-mcp:latest
    ports:
      - "${PRODUCTION_PORT:-8766}:${PRODUCTION_PORT:-8766}"
      - "${ADMIN_PORT:-8767}:${ADMIN_PORT:-8767}"
    environment:
      DATABASE_URL: postgresql://memory:${DB_PASSWORD}@memory-db:5432/memory
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    env_file:
      - .env
    depends_on:
      memory-db:
        condition: service_healthy
    networks:
      - memory
    restart: unless-stopped

  memory-backup:
    build: ./backup
    # image: ghcr.io/${GITHUB_ORG}/memory-backup:latest
    environment:
      DB_PASSWORD: ${DB_PASSWORD}
      GITHUB_PAT: ${GITHUB_PAT}
      GITHUB_REPO: ${GITHUB_BACKUP_REPO}
      BACKUP_INTERVAL_SECONDS: ${BACKUP_INTERVAL_SECONDS:-21600}
    volumes:
      - backup_cache:/backup
    depends_on:
      memory-db:
        condition: service_healthy
    networks:
      - memory
    restart: unless-stopped

volumes:
  memory_db:
  backup_cache:

networks:
  memory:
    driver: bridge
